<div class="app-container" (click)="handleBackgroundClick($event)">

  <!-- Finanzhaus Toggle Button -->
  <button
    class="finanzhaus-toggle no-select"
    [class.finanzhaus-toggle--active]="finanzhausVisible()"
    (click)="finanzhausVisible.set(!finanzhausVisible())"
    [title]="finanzhausVisible() ? t('finanzhaus.hide') : t('finanzhaus.show')"
  >
    <svg class="finanzhaus-toggle__icon" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
    </svg>
  </button>

  <!-- Data Mode Toggle Button (Beratung / Produkte) -->
  <button
    class="datamode-toggle no-select"
    (click)="toggleDataMode()"
    [title]="dataMode() === 'beratung' ? t('dataMode.switchToProdukte') : t('dataMode.switchToBeratung')"
  >
    <span class="datamode-toggle__label">{{ t('dataMode.' + dataMode()) }}</span>
    <svg class="datamode-toggle__icon" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
    </svg>
  </button>

  <!-- Zoom Controls -->
  <div class="zoom-controls no-select">
    <button class="zoom-btn" (click)="zoomIn()" [title]="t('controls.zoomIn')">
      <svg class="zoom-btn__icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
      </svg>
    </button>
    <button class="zoom-btn" (click)="zoomOut()" [title]="t('controls.zoomOut')">
      <svg class="zoom-btn__icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14" />
      </svg>
    </button>
    <div class="zoom-controls__divider"></div>
    <button class="zoom-btn zoom-btn--reset" (click)="resetView()" [title]="t('controls.reset')">
      <svg class="zoom-btn__icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
      </svg>
    </button>
  </div>

  <!-- Filter Indicator (Multi-Select) -->
  @if (activeCategories().size > 0) {
    <div class="filter-container no-select">
      <div class="filter-indicator">
        <span class="filter-indicator__label">{{ t('filter.label') }}</span>
        @for (catId of activeCategories(); track catId) {
          <span
            class="filter-indicator__value filter-indicator__value--clickable"
            [ngClass]="'category-' + catId"
            (click)="toggleCategory(catId)"
            [title]="t('filter.remove')"
          >
            {{ getCategoryLabel(catId) }}
          </span>
        }
        <button
          class="filter-indicator__close"
          (click)="clearAllFilters()"
          [title]="t('filter.removeAll')"
        >
          <svg class="filter-indicator__close-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
  }

  <!-- Finanzhaus Legend -->
  @if (finanzhausVisible()) {
    <div class="finanzhaus-wrapper">
      <app-finanzhaus
        [activeCategories]="activeCategories()"
        [hoveredCategories]="hoveredCategories()"
        (categorySelected)="toggleCategory($event)"
      />
    </div>
  }

  <!-- MindMap Visualization -->
  <div
    class="mindmap"
    [class.mindmap--panning]="isPanning()"
    [class.mindmap--dragging]="isDragging()"
    (mousedown)="onPanStart($event)"
    (mousemove)="onGlobalMouseMove($event)"
    (mouseup)="onGlobalMouseUp($event)"
    (mouseleave)="onGlobalMouseLeave()"
    (wheel)="onWheel($event)"
    (touchstart)="onTouchStart($event)"
    (touchmove)="onTouchMove($event)"
    (touchend)="onTouchEnd($event)"
    (touchcancel)="onTouchEnd($event)"
  >
    <div
      class="mindmap__center"
      [class.mindmap__center--focus-mode]="isInFocusMode()"
      [class.mindmap__center--filtering]="activeCategories().size > 0"
      [class.mindmap__center--settling]="isSimulating()"
      [class.mindmap__center--animating]="isAnimatingPan()"
      [style.margin-left.px]="panOffset().x"
      [style.margin-top.px]="panOffset().y"
      [style.transform]="'scale(' + zoomLevel() + ')'"
    >
      <!-- Rekursiver Einstieg: Level 0 (Root Node) -->
      <ng-container
        *ngTemplateOutlet="nodeTemplate; context: {
          $implicit: rootNode(),
          level: 0,
          parentNode: null,
          rootNode: rootNode(),
          parentAngle: 0,
          parentIsFocused: false,
          parentIsParent: false,
          parentInBranch: false
        }"
      ></ng-container>
    </div>
  </div>

  <!-- Tooltip (rendered outside MindMap hierarchy) -->
  @if (hoveredNode()?.tooltip && tooltipPosition()) {
    <div
      class="tooltip"
      [class.tooltip--below]="tooltipPosition()!.showBelow"
      [style.left.px]="tooltipPosition()!.x"
      [style.top.px]="tooltipPosition()!.y"
    >
      <div class="tooltip__content" [innerHTML]="hoveredNode()!.tooltip"></div>
    </div>
  }
</div>

<!-- Rekursives Node Template fÃ¼r alle Level -->
<ng-template #nodeTemplate
  let-node
  let-level="level"
  let-parentNode="parentNode"
  let-rootNode="rootNode"
  let-parentAngle="parentAngle"
  let-parentIsFocused="parentIsFocused"
  let-parentIsParent="parentIsParent"
  let-parentInBranch="parentInBranch"
>
  @let nodePos = getNodePosition(node, level, parentNode, parentAngle, parentIsFocused || parentIsParent || parentInBranch);
  @let isExpanded = isNodeExpandedAtLevel(node, level);
  @let isThisFocused = isFocusedNode(node);
  @let isThisParent = isFocusedParent(node);
  @let isThisInBranch = isInFocusedBranch(node);
  @let shouldHide = shouldHideNode(node, level, parentIsParent, parentInBranch, isThisFocused, isThisParent, isThisInBranch);
  @let isRootVisible = isRootVisibleInFocusMode(rootNode);

  @if (!shouldHide && ((+level) <= 1 ? isRootVisible : true)) {
    <div
      [class]="getNodeWrapperClass(level)"
      [class.node-wrapper--hidden]="!isRootVisible && (+level) === 1"
      [class.node-wrapper--focused]="isThisFocused"
      [class.node-wrapper--parent]="isThisParent"
      [class.node-wrapper--ancestor]="isThisInBranch"
      [class.node-wrapper--collapsing]="isNodeCollapsing(node)"
      [style.transform]="getNodeTransformForLevel(node, level, nodePos, isThisFocused, isThisParent, parentIsParent || parentInBranch, parentNode)"
    >
      <!-- Verbindungslinien zu Kindern -->
      @if (((+level) === 0 || isExpanded || isThisFocused || isThisParent || isThisInBranch) && node.children?.length) {
        <svg class="connections" [class.connections--level-0]="(+level) === 0" [class.connections--level-1]="(+level) === 1">
          @for (child of node.children; track child.id) {
            @let forceChildPos = getForcePosition(child);
            @let forceNodePos = getForcePosition(node);
            <line
              class="connections__line"
              [class.connections__line--blurred]="shouldBlurNode(child, (+level) + 1, node)"
              [class.connections__line--highlighted]="isLineOnHoveredPath(node, child)"
              x1="0" y1="0"
              [attr.x2]="forceChildPos.x - forceNodePos.x"
              [attr.y2]="forceChildPos.y - forceNodePos.y"
            />
          }
        </svg>
      }

      <!-- Der Node selbst -->
      <div
        class="node"
        [ngClass]="[
          getNodeLevelClass(level),
          (+level) >= 2 ? 'category-' + getPrimaryCategory(node) : '',
          isNodeDimmed(node, (+level), parentNode?.id) ? 'node--dimmed' : '',
          shouldBlurNode(node, (+level), parentNode) ? 'node--blurred' : '',
          isFocusedNode(node) ? 'node--focused' : '',
          isNodeDragging(node) ? 'node--dragging' : '',
          canDragNode(+level) ? 'node--draggable' : ''
        ]"
        (click)="(+level) >= 1 ? null : handleNodeClick(node, (+level), parentNode, rootNode)"
        (mousedown)="(+level) >= 1 ? onNodeDragStart($event, node, (+level), parentNode, rootNode) : null"
        (mouseenter)="onNodeMouseEnter($event, node)"
        (mouseleave)="onNodeMouseLeave()"
      >
        <div class="node__circle">
          <svg class="node__icon" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" [attr.d]="getNodeIconPath(node, level)" />
          </svg>
        </div>
        <span class="node__label no-select">{{ node.label }}</span>
      </div>

      <!-- Rekursive Kinder (Level 0 zeigt immer Kinder) -->
      @if (((+level) === 0 || isExpanded || isThisFocused || isThisParent || isThisInBranch) && node.children?.length) {
        <div [class]="'children-container children-container--level-' + (+level)">
          @for (child of node.children; track child.id) {
            <ng-container
              *ngTemplateOutlet="nodeTemplate; context: {
                $implicit: child,
                level: (+level) + 1,
                parentNode: node,
                rootNode: (+level) === 0 ? child : rootNode,
                parentAngle: nodePos.angle,
                parentIsFocused: isThisFocused,
                parentIsParent: isThisParent,
                parentInBranch: isThisInBranch
              }"
            ></ng-container>
          }
        </div>
      }
    </div>
  }
</ng-template>
