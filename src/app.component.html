<div class="app-container" (click)="handleBackgroundClick($event)">

  <!-- Finanzhaus Toggle Button -->
  <button
    class="finanzhaus-toggle no-select"
    [class.finanzhaus-toggle--active]="finanzhausVisible()"
    (click)="finanzhausVisible.set(!finanzhausVisible())"
    [title]="finanzhausVisible() ? t('finanzhaus.hide') : t('finanzhaus.show')"
  >
    <svg class="finanzhaus-toggle__icon" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
    </svg>
  </button>

  <!-- Zoom Controls -->
  <div class="zoom-controls no-select">
    <button class="zoom-btn" (click)="zoomIn()" title="Vergrößern">
      <svg class="zoom-btn__icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
      </svg>
    </button>
    <button class="zoom-btn" (click)="zoomOut()" title="Verkleinern">
      <svg class="zoom-btn__icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14" />
      </svg>
    </button>
  </div>

  <!-- Header Title -->
  <header class="header no-select">
    <h1 class="header__title">
      <span class="header__title-bold">{{ t('app.title') }}</span> {{ t('app.subtitle') }}
    </h1>
  </header>

  <!-- Filter Indicator -->
  @if (activeCategory()) {
    <div class="filter-container no-select">
      <div class="filter-indicator">
        <span class="filter-indicator__label">{{ t('filter.label') }}</span>
        <span
          class="filter-indicator__value"
          [ngClass]="'category-' + activeCategory()"
        >
          {{ getCategoryLabel(activeCategory()!) }}
        </span>
        <button
          class="filter-indicator__close"
          (click)="activeCategory.set(null)"
          [title]="t('filter.remove')"
        >
          <svg class="filter-indicator__close-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
  }

  <!-- Finanzhaus Legend -->
  @if (finanzhausVisible()) {
    <div class="finanzhaus-wrapper">
      <app-finanzhaus
        [activeCategory]="activeCategory()"
        [hoveredCategories]="hoveredCategories()"
        (categorySelected)="toggleCategory($event)"
      />
    </div>
  }

  <!-- MindMap Visualization -->
  <div
    class="mindmap"
    [class.mindmap--panning]="isPanning()"
    (mousedown)="onPanStart($event)"
    (mousemove)="onPanMove($event)"
    (mouseup)="onPanEnd()"
    (mouseleave)="onPanEnd()"
    (wheel)="onWheel($event)"
  >
    <div
      class="mindmap__center"
      [class.mindmap__center--focus-mode]="isInFocusMode()"
      [style.margin-left.px]="panOffset().x"
      [style.margin-top.px]="panOffset().y"
      [style.transform]="'scale(' + zoomLevel() + ')'"
    >
      <!-- Rekursiver Einstieg: Level 1 Nodes -->
      @for (node of mainNodes(); track node.id) {
        <ng-container
          *ngTemplateOutlet="nodeTemplate; context: {
            $implicit: node,
            level: 1,
            parentNode: null,
            rootNode: node,
            parentAngle: 0,
            parentIsFocused: false,
            parentIsParent: false,
            parentInBranch: false
          }"
        ></ng-container>
      }
    </div>
  </div>

  <!-- Tooltip (rendered outside MindMap hierarchy) -->
  @if (hoveredNode()?.tooltip && tooltipPosition()) {
    <div
      class="tooltip"
      [class.tooltip--below]="tooltipPosition()!.showBelow"
      [style.left.px]="tooltipPosition()!.x"
      [style.top.px]="tooltipPosition()!.y"
    >
      <div class="tooltip__content" [innerHTML]="hoveredNode()!.tooltip"></div>
    </div>
  }
</div>

<!-- Rekursives Node Template für alle Level -->
<ng-template #nodeTemplate
  let-node
  let-level="level"
  let-parentNode="parentNode"
  let-rootNode="rootNode"
  let-parentAngle="parentAngle"
  let-parentIsFocused="parentIsFocused"
  let-parentIsParent="parentIsParent"
  let-parentInBranch="parentInBranch"
>
  @let nodePos = getNodePosition(node, level, parentNode, parentAngle, parentIsFocused || parentIsParent || parentInBranch);
  @let isExpanded = isNodeExpandedAtLevel(node, level);
  @let isThisFocused = isFocusedNode(node);
  @let isThisParent = isFocusedParent(node);
  @let isThisInBranch = isInFocusedBranch(node);
  @let shouldHide = shouldHideNode(node, level, parentIsParent, parentInBranch, isThisFocused, isThisParent, isThisInBranch);
  @let isRootVisible = isRootVisibleInFocusMode(rootNode);

  @if (!shouldHide && ((+level) === 1 ? isRootVisible : true)) {
    <div
      [class]="getNodeWrapperClass(level)"
      [class.node-wrapper--hidden]="!isRootVisible && (+level) === 1"
      [class.node-wrapper--focused]="isThisFocused"
      [class.node-wrapper--parent]="isThisParent"
      [class.node-wrapper--ancestor]="isThisInBranch"
      [style.transform]="getNodeTransformForLevel(node, level, nodePos, isThisFocused, isThisParent, parentIsParent || parentInBranch, parentNode)"
    >
      <!-- Verbindungslinien zu Kindern (nur wenn erlaubt) -->
      @if ((isExpanded || isThisFocused || isThisParent || isThisInBranch) && node.children?.length && shouldDrawChildConnections(node)) {
        <svg class="connections" [class.connections--level-1]="(+level) === 1">
          @for (child of node.children; track child.id; let idx = $index) {
            @let childPos = getNodePosition(child, (+level) + 1, node, nodePos.angle, isThisFocused || isThisParent || isThisInBranch);
            @let zoomRelPos = getZoomChildRelativePosition(node, child);
            <line
              class="connections__line"
              x1="0" y1="0"
              [attr.x2]="zoomRelPos ? zoomRelPos.x : childPos.x"
              [attr.y2]="zoomRelPos ? zoomRelPos.y : childPos.y"
            />
          }
        </svg>
      }

      <!-- Ahnen-Verbindungslinie (horizontal zum nächsten Node) -->
      @if (getAncestorConnectionTarget(node); as ancestorTarget) {
        <svg class="connections connections--ancestor">
          <line
            class="connections__line"
            x1="0" y1="0"
            [attr.x2]="ancestorTarget.x"
            [attr.y2]="ancestorTarget.y"
          />
        </svg>
      }

      <!-- Der Node selbst -->
      <div
        class="node"
        [ngClass]="[
          isInFocusMode() && getZoomRole(node) ? 'node--zoom-' + getZoomRole(node) : getNodeLevelClass(level),
          (+level) >= 2 ? 'category-' + getPrimaryCategory(node) : '',
          isNodeDimmed(node, (+level), parentNode?.id) ? 'node--dimmed' : '',
          shouldBlurNode(node, (+level)) ? 'node--blurred' : ''
        ]"
        (click)="handleNodeClick(node, (+level), parentNode, rootNode)"
        (mouseenter)="onNodeMouseEnter($event, node)"
        (mouseleave)="onNodeMouseLeave()"
      >
        <div class="node__circle">
          <svg class="node__icon" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" [attr.d]="getNodeIconPath(node, level)" />
          </svg>
        </div>
        <span class="node__label no-select">{{ node.label }}</span>
      </div>

      <!-- Rekursive Kinder -->
      @if ((isExpanded || isThisFocused || isThisParent || isThisInBranch) && node.children?.length) {
        <div [class]="'children-container children-container--level-' + (+level)">
          @for (child of node.children; track child.id) {
            <ng-container
              *ngTemplateOutlet="nodeTemplate; context: {
                $implicit: child,
                level: (+level) + 1,
                parentNode: node,
                rootNode: rootNode,
                parentAngle: nodePos.angle,
                parentIsFocused: isThisFocused,
                parentIsParent: isThisParent,
                parentInBranch: isThisInBranch
              }"
            ></ng-container>
          }
        </div>
      }
    </div>
  }
</ng-template>
