<div
  class="app-container"
  (click)="handleBackgroundClick($event)"
  [style.--debug-l0-node-size]="nodeSizes().level0NodeSize + 'rem'"
  [style.--debug-l0-text-size]="nodeSizes().level0TextSize + 'rem'"
  [style.--debug-l1-node-size]="nodeSizes().level1NodeSize + 'rem'"
  [style.--debug-l1-text-size]="nodeSizes().level1TextSize + 'rem'"
  [style.--debug-l2-node-size]="nodeSizes().level2NodeSize + 'rem'"
  [style.--debug-l2-text-size]="nodeSizes().level2TextSize + 'rem'"
  [style.--debug-l3-node-size]="nodeSizes().level3NodeSize + 'rem'"
  [style.--debug-l3-text-size]="nodeSizes().level3TextSize + 'rem'"
>

  <!-- Finanzhaus Toggle Button -->
  <button
    class="finanzhaus-toggle no-select"
    [class.finanzhaus-toggle--active]="finanzhausVisible()"
    (click)="finanzhausVisible.set(!finanzhausVisible())"
    [title]="finanzhausVisible() ? t('finanzhaus.hide') : t('finanzhaus.show')"
  >
    <svg class="finanzhaus-toggle__icon" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
    </svg>
  </button>

  <!-- Data Mode Toggle Button (Beratung / Produkte) -->
  <button
    class="datamode-toggle no-select"
    (click)="toggleDataMode()"
    [title]="dataMode() === 'beratung' ? t('dataMode.switchToProdukte') : t('dataMode.switchToBeratung')"
  >
    <span class="datamode-toggle__label">{{ t('dataMode.' + dataMode()) }}</span>
    <svg class="datamode-toggle__icon" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
    </svg>
  </button>

  <!-- Zoom Controls -->
  <div class="zoom-controls no-select">
    <button class="zoom-btn" (click)="zoomIn()" [title]="t('controls.zoomIn')">
      <svg class="zoom-btn__icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
      </svg>
    </button>
    <button class="zoom-btn" (click)="zoomOut()" [title]="t('controls.zoomOut')">
      <svg class="zoom-btn__icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14" />
      </svg>
    </button>
    <div class="zoom-controls__divider"></div>
    <button class="zoom-btn zoom-btn--reset" (click)="resetView()" [title]="t('controls.reset')">
      <svg class="zoom-btn__icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
      </svg>
    </button>
    <div class="zoom-controls__divider"></div>
    <button
      class="zoom-btn"
      [class.zoom-btn--active]="debugPanelOpen()"
      (click)="toggleDebugPanel()"
      title="Debug: Node-Größen"
    >
      <svg class="zoom-btn__icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
      </svg>
    </button>
  </div>

  <!-- Debug Panel für Node-Größen -->
  @if (debugPanelOpen()) {
    <div class="debug-panel no-select">
      <div class="debug-panel__header">
        <span class="debug-panel__title">Node-Größen (rem)</span>
        <button class="debug-panel__reset" (click)="resetDebugSizes()">Reset</button>
      </div>

      <div class="debug-panel__section">
        <div class="debug-panel__section-title">Level 0</div>
        <div class="debug-panel__row">
          <label>Node:</label>
          <input
            type="number"
            [value]="nodeSizes().level0NodeSize"
            (input)="updateNodeSize('level0NodeSize', +$any($event.target).value)"
            min="0" max="10" step="0.1"
          >
          <span>{{ nodeSizes().level0NodeSize }}</span>
        </div>
        <div class="debug-panel__row">
          <label>Text:</label>
          <input
            type="number"
            [value]="nodeSizes().level0TextSize"
            (input)="updateNodeSize('level0TextSize', +$any($event.target).value)"
            min="0" max="10" step="0.1"
          >
          <span>{{ nodeSizes().level0TextSize }}</span>
        </div>
      </div>

      <div class="debug-panel__section">
        <div class="debug-panel__section-title">Level 1</div>
        <div class="debug-panel__row">
          <label>Node:</label>
          <input
            type="number"
            [value]="nodeSizes().level1NodeSize"
            (input)="updateNodeSize('level1NodeSize', +$any($event.target).value)"
            min="0" max="10" step="0.1"
          >
          <span>{{ nodeSizes().level1NodeSize }}</span>
        </div>
        <div class="debug-panel__row">
          <label>Text:</label>
          <input
            type="number"
            [value]="nodeSizes().level1TextSize"
            (input)="updateNodeSize('level1TextSize', +$any($event.target).value)"
            min="0" max="10" step="0.1"
          >
          <span>{{ nodeSizes().level1TextSize }}</span>
        </div>
      </div>

      <div class="debug-panel__section">
        <div class="debug-panel__section-title">Level 2</div>
        <div class="debug-panel__row">
          <label>Node:</label>
          <input
            type="number"
            [value]="nodeSizes().level2NodeSize"
            (input)="updateNodeSize('level2NodeSize', +$any($event.target).value)"
            min="0" max="10" step="0.1"
          >
          <span>{{ nodeSizes().level2NodeSize }}</span>
        </div>
        <div class="debug-panel__row">
          <label>Text:</label>
          <input
            type="number"
            [value]="nodeSizes().level2TextSize"
            (input)="updateNodeSize('level2TextSize', +$any($event.target).value)"
            min="0" max="10" step="0.1"
          >
          <span>{{ nodeSizes().level2TextSize }}</span>
        </div>
      </div>

      <div class="debug-panel__section">
        <div class="debug-panel__section-title">Level 3+</div>
        <div class="debug-panel__row">
          <label>Node:</label>
          <input
            type="number"
            [value]="nodeSizes().level3NodeSize"
            (input)="updateNodeSize('level3NodeSize', +$any($event.target).value)"
            min="0" max="10" step="0.1"
          >
          <span>{{ nodeSizes().level3NodeSize }}</span>
        </div>
        <div class="debug-panel__row">
          <label>Text:</label>
          <input
            type="number"
            [value]="nodeSizes().level3TextSize"
            (input)="updateNodeSize('level3TextSize', +$any($event.target).value)"
            min="0" max="10" step="0.1"
          >
          <span>{{ nodeSizes().level3TextSize }}</span>
        </div>
      </div>

      <div class="debug-panel__section">
        <div class="debug-panel__section-title">Hintergrundfarbe</div>
        <div class="debug-panel__row debug-panel__row--color">
          <input
            type="color"
            [value]="backgroundColor()"
            (input)="updateBackgroundColor($any($event.target).value)"
            class="debug-panel__color-picker"
          >
          <input
            type="text"
            [value]="backgroundColor()"
            (input)="updateBackgroundColor($any($event.target).value)"
            (blur)="updateBackgroundColor($any($event.target).value)"
            class="debug-panel__color-text"
            placeholder="#f9f6f1"
          >
          <button class="debug-panel__reset-small" (click)="resetBackgroundColor()">Reset</button>
        </div>
      </div>
    </div>
  }

  <!-- Filter Indicator (Multi-Select) -->
  @if (activeCategories().size > 0) {
    <div class="filter-container no-select">
      <div class="filter-indicator">
        <span class="filter-indicator__label">{{ t('filter.label') }}</span>
        @for (catId of activeCategories(); track catId) {
          <span
            class="filter-indicator__value filter-indicator__value--clickable"
            [ngClass]="'category-' + catId"
            (click)="toggleCategory(catId)"
            [title]="t('filter.remove')"
          >
            {{ getCategoryLabel(catId) }}
          </span>
        }
        <button
          class="filter-indicator__close"
          (click)="clearAllFilters()"
          [title]="t('filter.removeAll')"
        >
          <svg class="filter-indicator__close-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
  }

  <!-- Finanzhaus Legend -->
  @if (finanzhausVisible()) {
    <div class="finanzhaus-wrapper">
      <app-finanzhaus
        [activeCategories]="activeCategories()"
        [hoveredCategories]="hoveredCategories()"
        [selectedL2NodeIds]="selectedL2NodeIds()"
        [hoveredL2NodeId]="hoveredL2NodeId()"
        (categorySelected)="toggleCategory($event)"
        (l2Selected)="handleL2Selection($event)"
      />
    </div>
  }

  <!-- MindMap Visualization -->
  <div
    class="mindmap"
    [class.mindmap--panning]="isPanning()"
    [class.mindmap--dragging]="isDragging()"
    (mousedown)="onPanStart($event)"
    (mousemove)="onGlobalMouseMove($event)"
    (mouseup)="onGlobalMouseUp($event)"
    (mouseleave)="onGlobalMouseLeave()"
    (wheel)="onWheel($event)"
    (touchstart)="onTouchStart($event)"
    (touchmove)="onTouchMove($event)"
    (touchend)="onTouchEnd($event)"
    (touchcancel)="onTouchEnd($event)"
  >
    <div
      class="mindmap__center"
      [class.mindmap__center--focus-mode]="isInFocusMode()"
      [class.mindmap__center--focus-level-1]="getFocusedLevel() === 1"
      [class.mindmap__center--filtering]="activeCategories().size > 0"
      [class.mindmap__center--settling]="isSimulating()"
      [class.mindmap__center--animating]="isAnimatingPan()"
      [style.margin-left.px]="panOffset().x"
      [style.margin-top.px]="panOffset().y"
      [style.transform]="'scale(' + zoomLevel() + ')'"
    >
      <!-- Rekursiver Einstieg: Level 0 (Root Node) -->
      <ng-container
        *ngTemplateOutlet="nodeTemplate; context: {
          $implicit: rootNode(),
          level: 0,
          parentNode: null,
          rootNode: rootNode(),
          parentAngle: 0,
          parentIsFocused: false,
          parentIsParent: false,
          parentInBranch: false
        }"
      ></ng-container>

    </div>
  </div>

  <!-- Info-Panel für L3+ Nodes (außerhalb MindMap, immer oben) -->
  @if (selectedInfoNode(); as infoNode) {
    @if (infoNode.tooltip && infoPanelPosition(); as pos) {
      <div
        class="info-panel"
        [style.left.px]="pos.x"
        [style.top.px]="pos.y"
        (click)="$event.stopPropagation()"
        (mousedown)="$event.stopPropagation()"
      >
        <div class="info-panel__content" [innerHTML]="infoNode.tooltip"></div>
      </div>
    }
  }

  <!-- Hover-Tooltip für L0-L2 (rendered outside MindMap hierarchy) -->
  @if (hoveredNode()?.tooltip && tooltipPosition()) {
    <div
      class="tooltip"
      [class.tooltip--below]="tooltipPosition()!.showBelow"
      [style.left.px]="tooltipPosition()!.x"
      [style.top.px]="tooltipPosition()!.y"
    >
      <div class="tooltip__content" [innerHTML]="hoveredNode()!.tooltip"></div>
    </div>
  }
</div>

<!-- Rekursives Node Template für alle Level -->
<ng-template #nodeTemplate
  let-node
  let-level="level"
  let-parentNode="parentNode"
  let-rootNode="rootNode"
  let-parentAngle="parentAngle"
  let-parentIsFocused="parentIsFocused"
  let-parentIsParent="parentIsParent"
  let-parentInBranch="parentInBranch"
>
  @let nodePos = getNodePosition(node, level, parentNode, parentAngle, parentIsFocused || parentIsParent || parentInBranch);
  @let isExpanded = isNodeExpandedAtLevel(node, level);
  @let isThisFocused = isFocusedNode(node);
  @let isThisParent = isFocusedParent(node);
  @let isThisInBranch = isInFocusedBranch(node);
  @let shouldHide = shouldHideNode(node, level, parentIsParent, parentInBranch, isThisFocused, isThisParent, isThisInBranch);
  @let isRootVisible = isRootVisibleInFocusMode(rootNode);

  @if (!shouldHide && ((+level) <= 1 ? isRootVisible : true)) {
    <div
      [class]="getNodeWrapperClass(level)"
      [class.node-wrapper--hidden]="!isRootVisible && (+level) === 1"
      [class.node-wrapper--focused]="isThisFocused"
      [class.node-wrapper--parent]="isThisParent"
      [class.node-wrapper--ancestor]="isThisInBranch"
      [class.node-wrapper--collapsing]="isNodeCollapsing(node)"
      [style.transform]="getNodeTransformForLevel(node, level, nodePos, isThisFocused, isThisParent, parentIsParent || parentInBranch, parentNode)"
    >
      <!-- Verbindungslinien zu Kindern -->
      @if (((+level) === 0 || isExpanded || isThisFocused || isThisParent || isThisInBranch) && node.children?.length) {
        <svg class="connections" [class.connections--level-0]="(+level) === 0" [class.connections--level-1]="(+level) === 1" [class.connections--level-2]="(+level) === 2">
          @for (child of node.children; track child.id) {
            @let forceChildPos = getForcePosition(child);
            @let forceNodePos = getForcePosition(node);
            <line
              class="connections__line"
              [class.connections__line--blurred]="shouldBlurNode(child, (+level) + 1, node)"
              [class.connections__line--highlighted]="isLineOnHoveredPath(node, child, +level)"
              x1="0" y1="0"
              [attr.x2]="forceChildPos.x - forceNodePos.x"
              [attr.y2]="forceChildPos.y - forceNodePos.y"
            />
          }
        </svg>
      }

      <!-- Der Node selbst -->
      @let isInfoSelected = selectedInfoNode()?.id === node.id;
      <div
        class="node"
        [ngClass]="[
          getNodeLevelClass(level),
          (+level) >= 2 ? 'category-' + getPrimaryCategory(node) : '',
          (+level) === 1 ? 'l1-border-' + getPrimaryCategory(node) : '',
          (+level) === 0 ? 'l0-border' : '',
          isNodeDimmed(node, (+level), parentNode?.id) ? 'node--dimmed' : '',
          shouldBlurNode(node, (+level), parentNode) ? 'node--blurred' : '',
          isFocusedNode(node) ? 'node--focused' : '',
          isNodeInFocus(node) ? 'node--multi-focused' : '',
          isNodeDragging(node) ? 'node--dragging' : '',
          canDragNode(+level) ? 'node--draggable' : '',
          isInfoSelected ? 'node--info-selected' : ''
        ]"
        (click)="(+level) >= 1 ? $event.stopPropagation() : handleNodeClick(node, (+level), parentNode, rootNode)"
        (mousedown)="(+level) >= 1 ? onNodeDragStart($event, node, (+level), parentNode, rootNode) : null"
        (touchstart)="(+level) >= 1 ? onNodeTouchStart($event, node, (+level), parentNode, rootNode) : null"
        (contextmenu)="onNodeContextMenu($event, node, (+level))"
        (mouseenter)="onNodeMouseEnter($event, node, +level)"
        (mouseleave)="onNodeMouseLeave()"
      >
        <div class="node__circle">
          @if ((+level) === 0 && getL0ImagePath(node.id)) {
            <img class="node__icon-image node__icon-image--l0" [src]="getL0ImagePath(node.id)" [alt]="node.label" />
          } @else if ((+level) === 1 && getL1ImagePath(node.id)) {
            <img class="node__icon-image node__icon-image--l1" [src]="getL1ImagePath(node.id)" [alt]="node.label" />
          } @else if ((+level) === 2 && getL2ImagePath(node.id)) {
            <img class="node__icon-image node__icon-image--l2" [src]="getL2ImagePath(node.id)" [alt]="node.label" />
          } @else if ((+level) === 2 && rootNode && getL1ImagePath(rootNode.id)) {
            <img class="node__icon-image node__icon-image--l2" [src]="getL1ImagePath(rootNode.id)" [alt]="node.label" />
          } @else if ((+level) >= 3 && parentNode && getL2ImagePath(parentNode.id)) {
            <img class="node__icon-image node__icon-image--l3" [src]="getL2ImagePath(parentNode.id)" [alt]="node.label" />
          } @else if ((+level) >= 3 && rootNode && getL1ImagePath(rootNode.id)) {
            <img class="node__icon-image node__icon-image--l3" [src]="getL1ImagePath(rootNode.id)" [alt]="node.label" />
          } @else {
            <svg class="node__icon" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" [attr.d]="getNodeIconPath(node, level)" />
            </svg>
          }
        </div>
        <span class="node__label no-select">{{ node.label }}</span>

        <!-- Circular Arrange Button - erscheint bei expandiertem oder fokussiertem Level 1/2 Node mit Kindern -->
        @if (((+level) === 1 || (+level) === 2) && (isExpanded || isThisFocused) && node.children?.length) {
          <button
            class="node__arrange-btn no-select"
            (click)="arrangeChildrenCircular(node, $event)"
            (mousedown)="$event.stopPropagation()"
            title="Kinder kreisförmig anordnen"
          >
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="9" stroke-dasharray="4 2" />
              <circle cx="12" cy="5" r="2" fill="currentColor" />
              <circle cx="18" cy="10" r="2" fill="currentColor" />
              <circle cx="16" cy="17" r="2" fill="currentColor" />
              <circle cx="8" cy="17" r="2" fill="currentColor" />
              <circle cx="6" cy="10" r="2" fill="currentColor" />
            </svg>
          </button>
        }
      </div>

      <!-- Rekursive Kinder (Level 0 zeigt immer Kinder) -->
      @if (((+level) === 0 || isExpanded || isThisFocused || isThisParent || isThisInBranch) && node.children?.length) {
        <div [class]="'children-container children-container--level-' + (+level)">
          @for (child of node.children; track child.id) {
            <ng-container
              *ngTemplateOutlet="nodeTemplate; context: {
                $implicit: child,
                level: (+level) + 1,
                parentNode: node,
                rootNode: (+level) === 0 ? child : rootNode,
                parentAngle: nodePos.angle,
                parentIsFocused: isThisFocused,
                parentIsParent: isThisParent,
                parentInBranch: isThisInBranch
              }"
            ></ng-container>
          }
        </div>
      }
    </div>
  }
</ng-template>
