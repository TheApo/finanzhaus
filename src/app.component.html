<div class="app-container" (click)="handleBackgroundClick($event)">

  <!-- Finanzhaus Toggle Button -->
  <button
    class="finanzhaus-toggle no-select"
    [class.finanzhaus-toggle--active]="finanzhausVisible()"
    (click)="finanzhausVisible.set(!finanzhausVisible())"
    [title]="finanzhausVisible() ? t('finanzhaus.hide') : t('finanzhaus.show')"
  >
    <svg class="finanzhaus-toggle__icon" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
    </svg>
  </button>

  <!-- Header Title -->
  <header class="header no-select">
    <h1 class="header__title">
      <span class="header__title-bold">{{ t('app.title') }}</span> {{ t('app.subtitle') }}
    </h1>
  </header>

  <!-- Filter Indicator -->
  @if (activeCategory()) {
    <div class="filter-container no-select">
      <div class="filter-indicator">
        <span class="filter-indicator__label">{{ t('filter.label') }}</span>
        <span
          class="filter-indicator__value"
          [ngClass]="'category-' + activeCategory()"
        >
          {{ getCategoryLabel(activeCategory()!) }}
        </span>
        <button
          class="filter-indicator__close"
          (click)="activeCategory.set(null)"
          [title]="t('filter.remove')"
        >
          <svg class="filter-indicator__close-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
  }

  <!-- Finanzhaus Legend -->
  @if (finanzhausVisible()) {
    <div class="finanzhaus-wrapper">
      <app-finanzhaus
        [activeCategory]="activeCategory()"
        [hoveredCategories]="hoveredCategories()"
        (categorySelected)="toggleCategory($event)"
      />
    </div>
  }

  <!-- MindMap Visualization -->
  <div class="mindmap">
    <div class="mindmap__center mindmap-scale">

      @for (l1 of mainNodes(); track l1.id) {
        <!-- L1 Cluster -->
        <div
          class="l1-cluster"
          [class.l1-cluster--dimmed]="isNodeDimmed(l1, 1, null)"
          [style.transform]="getL1Transform(l1.id)"
        >
          <!-- L1 Node -->
          <div
            class="node node--l1"
            (click)="handleNodeClick(l1, 1)"
            (mouseenter)="onNodeMouseEnter($event, l1)"
            (mouseleave)="onNodeMouseLeave()"
          >
            <svg class="node__icon" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              @switch (l1.icon) {
                @case ('person') {
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                }
                @case ('truck') {
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 0 1-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 0 0-3.213-9.193 2.056 2.056 0 0 0-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 0 0-10.026 0 1.106 1.106 0 0 0-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12" />
                }
                @case ('users') {
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
                }
                @case ('building') {
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Z" />
                }
              }
            </svg>
            <span class="node__label no-select">{{ l1.label }}</span>
          </div>

          <!-- L2 Container -->
          @if (isL1Expanded(l1)) {
            <div class="l2-container">
              @for (l2 of l1.children || []; track l2.id; let i = $index) {
                @let l2Pos = getL2Position(i, l1.children?.length || 0);
                @let l2Open = isL2Expanded(l2, l1);

                <!-- L2 Wrapper -->
                <div
                  class="l2-wrapper"
                  [style.--translate-x]="l2Pos.x + 'px'"
                  [style.--translate-y]="l2Pos.y + 'px'"
                  [style.transform]="'translate(' + l2Pos.x + 'px, ' + l2Pos.y + 'px)'"
                  [class.node--dimmed]="isNodeDimmed(l2, 2, l1.id)"
                >
                  <!-- Connection Lines to L3 -->
                  @if (l2Open && l2.children?.length) {
                    <svg class="connections">
                      @for (l3 of l2.children || []; track l3.id; let j = $index) {
                        @let l3Pos = getL3Position(j, l2.children?.length || 0, l2Pos.angle);
                        <line
                          class="connections__line"
                          x1="0" y1="0"
                          [attr.x2]="l3Pos.x"
                          [attr.y2]="l3Pos.y"
                          marker-end="url(#arrowhead)"
                        />
                      }
                      <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="36" refY="3.5" orient="auto">
                          <polygon class="connections__arrowhead" points="0 0, 10 3.5, 0 7" />
                        </marker>
                      </defs>
                    </svg>
                  }

                  <!-- L2 Node -->
                  <div
                    class="node node--l2"
                    [ngClass]="'category-' + getPrimaryCategory(l2)"
                    (click)="handleNodeClick(l2, 2, l1)"
                    (mouseenter)="onNodeMouseEnter($event, l2)"
                    (mouseleave)="onNodeMouseLeave()"
                  >
                    <span class="node__label no-select hyphens-auto">{{ l2.label }}</span>
                  </div>

                  <!-- L3 Children -->
                  @if (l2Open) {
                    <div class="l3-container">
                      @for (l3 of l2.children || []; track l3.id; let j = $index) {
                        @let l3Pos = getL3Position(j, l2.children?.length || 0, l2Pos.angle);

                        <!-- L3 Wrapper -->
                        <div
                          class="l3-wrapper"
                          [style.--translate-x]="l3Pos.x + 'px'"
                          [style.--translate-y]="l3Pos.y + 'px'"
                          [style.transform]="'translate(' + l3Pos.x + 'px, ' + l3Pos.y + 'px)'"
                        >
                          <!-- L3 Node -->
                          <div
                            class="node node--l3"
                            [ngClass]="'category-' + getPrimaryCategory(l3)"
                            [class.node--dimmed]="isNodeDimmed(l3, 3, l2.id)"
                            (mouseenter)="onNodeMouseEnter($event, l3)"
                            (mouseleave)="onNodeMouseLeave()"
                          >
                            <span class="node__label no-select hyphens-auto">{{ l3.label }}</span>
                          </div>
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  </div>

  <!-- Tooltip (rendered outside MindMap hierarchy) -->
  @if (hoveredNode()?.tooltip && tooltipPosition()) {
    <div
      class="tooltip"
      [class.tooltip--below]="tooltipPosition()!.showBelow"
      [style.left.px]="tooltipPosition()!.x"
      [style.top.px]="tooltipPosition()!.y"
    >
      <div class="tooltip__content" [innerHTML]="hoveredNode()!.tooltip"></div>
    </div>
  }
</div>
