<div class="relative w-full h-screen bg-slate-50 overflow-hidden font-sans text-slate-800 mindmap-container" (click)="handleBackgroundClick($event)">
  
  <!-- Reset / Info Header -->
  <div class="absolute top-4 left-4 z-50 pointer-events-none select-none">
    <h1 class="text-xl font-bold text-slate-700 mb-1 pointer-events-auto">Finanzhaus Navigator</h1>
    <p class="text-sm text-slate-500 mb-2 pointer-events-auto">Interaktive Beratungshilfe</p>

    <!-- Filter Indicator -->
    @if (activeCategory()) {
      <div class="flex items-center gap-2 mb-3 pointer-events-auto">
        <span class="text-xs text-slate-500">Filter:</span>
        <span
          class="px-2 py-1 rounded text-xs font-semibold"
          [ngClass]="[getCategoryColor(activeCategory()!), getCategoryTextColor(activeCategory()!)]"
        >
          {{ getCategoryLabel(activeCategory()!) }}
        </span>
        <button
          (click)="resetView()"
          class="text-slate-400 hover:text-slate-600 cursor-pointer"
          title="Filter entfernen"
        >
          ✕
        </button>
      </div>
    }

    <button (click)="resetView()" class="px-3 py-1 bg-white border border-slate-300 rounded shadow hover:bg-slate-50 text-xs pointer-events-auto cursor-pointer">
      Ansicht zurücksetzen
    </button>
  </div>

  <!-- Legend / Filter (Bottom Left) -->
  <div class="absolute bottom-4 left-4 z-50">
    <app-finanzhaus 
      [activeCategory]="activeCategory()" 
      (categorySelected)="toggleCategory($event)"
    ></app-finanzhaus>
  </div>

  <!-- Main Visualization Container (Centered) -->
  <div class="absolute inset-0 pointer-events-none">
    
    <!-- We create a central point in the screen -->
    <div class="absolute top-1/2 left-1/2 w-0 h-0">

      @for (l1 of mainNodes(); track l1.id) {
        <!-- Main Cluster Wrapper - Brought closer to center (reduced offsets) -->
        <div 
          class="absolute w-0 h-0 transition-all duration-700 ease-in-out"
          [style.transform]="
            l1.id === 'unternehmer_privat' ? 'translate(0, -220px)' :
            l1.id === 'muster_gmbh' ? 'translate(0, 220px)' :
            l1.id === 'lieferanten' ? 'translate(-420px, 0)' :
            'translate(420px, 0)'
          "
          [class.opacity-10]="isNodeDimmed(l1, 1, null)"
        >

          <!-- Level 1 Node - einheitliches Design mit Icon + Text -->
          <div
            class="absolute pointer-events-auto z-30 w-28 h-28 -translate-x-1/2 -translate-y-1/2 rounded-full shadow-2xl flex flex-col items-center justify-center text-center p-2 cursor-pointer hover:scale-105 transition-transform duration-300 border-4 border-slate-200 bg-white text-slate-600"
            (click)="handleNodeClick(l1, 1)"
          >
            <!-- Icon (SVG) -->
            <svg class="w-8 h-8 mb-1 text-slate-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              @switch (l1.icon) {
                @case ('person') {
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                }
                @case ('truck') {
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 0 1-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 0 0-3.213-9.193 2.056 2.056 0 0 0-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 0 0-10.026 0 1.106 1.106 0 0 0-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12" />
                }
                @case ('users') {
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
                }
                @case ('building') {
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Z" />
                }
              }
            </svg>
            <!-- Label -->
            <span class="font-semibold text-[10px] leading-tight select-none">{{ l1.label }}</span>

            <!-- Pulse indicator -->
            @if (!isL1Expanded(l1) && l1.children?.length) {
              <div class="absolute -bottom-2 bg-slate-300 rounded-full p-1.5 animate-pulse"></div>
            }
          </div>

          <!-- Level 2 Container -->
          @if (isL1Expanded(l1)) {
             <div class="absolute top-0 left-0 w-0 h-0 overflow-visible flex items-center justify-center">
                
                @for (l2 of l1.children || []; track l2.id; let i = $index) {
                  @let l2Pos = getL2Position(i, l1.children?.length || 0);
                  @let l2Open = isL2Expanded(l2, l1);

                  <!-- Level 2 Wrapper -->
                  <div
                    class="absolute top-0 left-0 w-0 h-0 bloom-enter transition-all duration-500"
                    [ngStyle]="getL2Style(i, l1.children?.length || 0)"
                    [style.filter]="isNodeDimmed(l2, 2, l1.id) ? 'opacity(0.25) grayscale(0.8)' : null"
                  >
                    
                    <!-- SVG Arrows to Level 3 -->
                    @if (l2Open && l2.children?.length) {
                       <svg class="absolute top-0 left-0 overflow-visible pointer-events-none" style="z-index: -1;">
                          @for (l3 of l2.children || []; track l3.id; let j = $index) {
                             @let l3Pos = getL3Position(j, l2.children?.length || 0, l2Pos.angle);
                             <line 
                                x1="0" y1="0" 
                                [attr.x2]="l3Pos.x" 
                                [attr.y2]="l3Pos.y" 
                                stroke="#94a3b8" 
                                stroke-width="2" 
                                marker-end="url(#arrowhead)"
                             />
                          }
                          <defs>
                            <!-- refX adjusted for smaller L2 radius (approx 40px) -->
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="36" refY="3.5" orient="auto">
                              <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                            </marker>
                          </defs>
                       </svg>
                    }

                    <!-- Level 2 Node (Reduced size: w-20 h-20) -->
                    <div 
                      class="absolute pointer-events-auto w-20 h-20 -translate-x-1/2 -translate-y-1/2 rounded-full shadow-xl flex items-center justify-center text-center p-2 border-[3px] border-white hover:z-40 hover:scale-110 transition-transform cursor-pointer"
                      [ngClass]="[getCategoryColor(getPrimaryCategory(l2)), getCategoryTextColor(getPrimaryCategory(l2))]"
                      (click)="handleNodeClick(l2, 2, l1)"
                    >
                      <span class="text-[10px] font-semibold leading-tight select-none drop-shadow-sm">{{ l2.label }}</span>
                    </div>

                    <!-- Level 3 Children -->
                    @if (l2Open) {
                       <div class="absolute top-0 left-0 w-0 h-0 overflow-visible">
                          @for (l3 of l2.children || []; track l3.id; let j = $index) {
                             <!-- Level 3 Wrapper -->
                             <div
                                class="absolute top-0 left-0 w-0 h-0 bloom-enter"
                                [ngStyle]="getL3Style(j, l2.children?.length || 0, l2Pos.angle)"
                             >
                                <!-- Level 3 Node -->
                                <div
                                  class="absolute pointer-events-auto w-14 h-14 -translate-x-1/2 -translate-y-1/2 rounded-full shadow-md flex items-center justify-center text-center p-1 border-2 border-white cursor-pointer hover:scale-110 transition-transform"
                                  [ngClass]="[getCategoryColor(getPrimaryCategory(l3)), getCategoryTextColor(getPrimaryCategory(l3))]"
                                  [style.filter]="isNodeDimmed(l3, 3, l2.id) ? 'opacity(0.25) grayscale(0.8)' : null"
                                  (mouseenter)="hoveredNode.set(l3)"
                                  (mouseleave)="hoveredNode.set(null)"
                                >
                                  <span class="text-[9px] font-medium leading-tight select-none">{{ l3.label }}</span>

                                  <!-- Tooltip Cloud -->
                                  @if (l3.tooltip && hoveredNode() === l3) {
                                    <div class="tooltip-cloud text-slate-600 text-xs leading-relaxed text-left" [innerHTML]="l3.tooltip"></div>
                                  }
                                </div>
                             </div>
                          }
                       </div>
                    }

                  </div>
                }

             </div>
          }

        </div>
      }
    </div>
  </div>
</div>